<html><body><head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
    </style>
</head>
    <p id="p1"> 
        <br><svg id="cali-map" height="1500" width="1990" style="margin:20px" />
        </svg>
        <svg id="controllers"></svg>
        
        <script>
            const svg = d3.select('svg#cali-map');
            const controllers = d3.select('svg#controllers');
            const map = svg.append("g");
            const svgWidth = svg.attr("width");
            const svgHeight = svg.attr("height");
            const requestData = async function() {
                const data = await d3.csv("dataset/companies.csv");
                const ca = await d3.json("dataset/caCountiesTopoSimple.json");
                
                const counties = topojson.feature(ca, ca.objects.subunits)
                const projection = d3.geoMercator().fitSize([svgWidth, svgHeight], counties);
                const path = d3.geoPath().projection(projection);

                data.forEach((d, i) => {
                    d.position = projection([d.Longitude, d.Latitude])
                    console.log(d.Latitude,d.position)
                })
                console.log(data, ca)
                
                map.selectAll(".subunit")
                    .data(counties.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("fill", "#ddd")
                    .attr("stroke", "white")
                    .attr("translate", [300, 300]);

                    // map.append("path")
                    // .datum(counties)
                    // .join("path")
                    // .attr("d", path)
                    // .attr("fill", "blue")
                    // .attr("translate", [300, 300]);

                const xScale = d3.scaleLinear().domain([36, 40]).range([150, 250])
                const yScale = d3.scaleLinear().domain([-80, -122]).range([0, 200])
                function plotZoomed(event) {
                    layer.attr("transform", event.transform)
                    map.attr("transform", event.transform)
                }
                const plotZoom = d3.zoom().on("zoom", plotZoomed)
                svg.call(plotZoom)
                const contours = d3.contourDensity()
                    .x(d => d.position[0])
                    .y(d => d.position[1])
                    .size([svgWidth, svgHeight])
                    .bandwidth(11)
                    .thresholds(50)(data)
                console.log('data',d3.max(data, d => d.Longitude),d3.min(data, d => d.Longitude),ca,data, d3.contourDensity()
                    .x(d => xScale(d.Latitude))
                    .y(d => {return yScale(d.Longitude)})
                    .size([200, 200])
                    .thresholds(10)(data))
                const extent = d3.extent(contours, d => {console.log(d, d.value); return d.value})
                const colorScale = d3.scaleSequential(d3.interpolateViridis).domain(extent)
                const layer = svg.append("g");
                controllers.append("rect")
                    .attr("x", 100)
                    .attr("y", 100)
                    .attr("height", 50)
                    .attr("width", 50)
                    .attr("color", "green")
                    .text("contour")
                    .on('click', function(e) {
                        layer.selectAll("circle")
                            .attr("visibility", "hidden")
                    })
                layer.selectAll("circle").data(data)
                    .join("circle")
                    .attr("r", 1)
                    .attr("fill", "forestgreen")
                    .attr("opacity", 0.4)
                    .attr("cx", d => d.position[0])
                    .attr("cy", d => d.position[1]);
                layer.selectAll("path.contours")
                    .data(contours)
                    .join("path")
                    .attr("fill", d => {
                        return colorScale(d.value)
                    })
                    .attr("d", d3.geoPath())
                    
            }   
            requestData();
        </script>
    </p>
  </body></html>